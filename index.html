<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#0b0b0f" />

    <!-- iOS Add to Home Screen -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />

    <title>CuePad</title>

    <style>
      :root {
        color-scheme: dark;
      }
      body {
        margin: 16px;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        background: #0b0b0f;
        color: #eaeaf2;
      }
      .app {
        display: grid;
        gap: 12px;
        grid-template-columns: 320px 1fr;
      }
      @media (max-width: 900px) {
        .app {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: #12121a;
        border: 1px solid #222232;
        border-radius: 14px;
        padding: 12px;
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }
      .muted {
        color: #a8a8c2;
        font-size: 12px;
      }
      .btn {
        background: #181826;
        border: 1px solid #2b2b45;
        color: #eaeaf2;
        padding: 8px 10px;
        border-radius: 12px;
        cursor: pointer;
      }
      .btn.primary {
        border-color: #2c4a7a;
        background: #131a2a;
      }
      .btn.danger {
        border-color: #4a2530;
        background: #1a1015;
      }

      .drop {
        margin-top: 10px;
        border: 2px dashed #3a3a55;
        border-radius: 14px;
        padding: 12px;
        text-align: center;
      }
      .drop.drag {
        border-color: #eaeaf2;
      }

      .lib {
        margin-top: 10px;
        display: grid;
        gap: 8px;
        max-height: 42vh;
        overflow: auto;
      }

      .item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #10101a;
        border: 1px solid #222232;
        border-radius: 12px;
        padding: 10px;
      }

      .pads {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      @media (max-width: 500px) {
        .pads {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .pad {
        background: #0f0f18;
        border: 1px solid #222232;
        border-radius: 16px;
        padding: 12px;
        min-height: 86px;
        cursor: pointer;
      }
      .pad.active {
        outline: 2px solid #eaeaf2;
      }
      .pad.drag {
        outline: 2px solid #7fd1ff;
      }

      input[type="range"] {
        width: 100%;
      }
      select {
        background: #0f0f18;
        border: 1px solid #222232;
        color: #eaeaf2;
        padding: 8px;
        border-radius: 12px;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>CuePad</h1>
      <div class="muted">
        Mobile-friendly drum pad / soundboard. Sounds are stored locally on your
        device.
      </div>
    </div>

    <div class="app">
      <!-- LEFT -->
      <div class="card">
        <div class="row" style="justify-content: space-between">
          <strong>Library</strong>
          <button class="btn danger" id="clearAll">Clear All</button>
        </div>

        <div id="drop" class="drop">
          Drag audio files here (desktop)<br />
          <span class="muted">Mobile: use Import Sounds</span>
        </div>

        <div class="row" style="margin-top: 10px">
          <button class="btn" id="exportKit">Export Kit</button>

          <!-- SOUND IMPORT -->
          <input
            id="importSoundsFile"
            type="file"
            multiple
            accept="audio/*"
            hidden
          />
          <button class="btn primary" id="importSounds">Import Sounds</button>

          <!-- KIT IMPORT -->
          <input
            id="importKitFile"
            type="file"
            accept="application/json"
            hidden
          />
          <button class="btn" id="importKit">Import Kit</button>
        </div>

        <div id="lib" class="lib"></div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card row">
          <button class="btn primary" id="arm">Tap to Arm Audio</button>
          <button class="btn" id="stopAll">Stop All</button>
        </div>

        <div class="card" style="margin-top: 10px">
          <div class="pads" id="pads"></div>
        </div>
      </div>
    </div>

    <script>
      const PAD_COUNT = 16;
      const DB_NAME = "cuepad_db";
      let db,
        sounds = [],
        kit = Array.from({ length: PAD_COUNT }, () => ({ soundId: null }));

      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const audioCtx = new AudioCtx();
      const bufferCache = new Map();

      const padsEl = document.getElementById("pads");
      const libEl = document.getElementById("lib");
      const dropEl = document.getElementById("drop");

      const importSoundsBtn = document.getElementById("importSounds");
      const importSoundsFile = document.getElementById("importSoundsFile");
      const importKitBtn = document.getElementById("importKit");
      const importKitFile = document.getElementById("importKitFile");

      function openDb() {
        return new Promise((res) => {
          const r = indexedDB.open(DB_NAME, 1);
          r.onupgradeneeded = (e) => {
            const d = e.target.result;
            d.createObjectStore("sounds", { keyPath: "id" });
            d.createObjectStore("kit", { keyPath: "key" });
          };
          r.onsuccess = () => res(r.result);
        });
      }

      function store(name, mode = "readonly") {
        return db.transaction(name, mode).objectStore(name);
      }

      function uuid() {
        return crypto.randomUUID
          ? crypto.randomUUID()
          : String(Date.now()) + Math.random();
      }

      async function load() {
        sounds = await new Promise((r) => {
          const q = store("sounds").getAll();
          q.onsuccess = () => r(q.result || []);
        });
        const saved = await new Promise((r) => {
          const q = store("kit").get("default");
          q.onsuccess = () => r(q.result?.kit);
        });
        if (saved) kit = saved;
        render();
      }

      function render() {
        padsEl.innerHTML = "";
        for (let i = 0; i < PAD_COUNT; i++) {
          const p = document.createElement("div");
          p.className = "pad";
          const s = sounds.find((x) => x.id === kit[i].soundId);
          p.textContent = s ? s.name : `Pad ${i + 1}`;
          p.onclick = async () => {
            if (!s) return;
            if (audioCtx.state !== "running") await audioCtx.resume();
            let buf = bufferCache.get(s.id);
            if (!buf) {
              buf = await audioCtx.decodeAudioData(s.data.slice(0));
              bufferCache.set(s.id, buf);
            }
            const src = audioCtx.createBufferSource();
            src.buffer = buf;
            src.connect(audioCtx.destination);
            src.start();
          };
          padsEl.appendChild(p);
        }

        libEl.innerHTML = "";
        sounds.forEach((sound) => {
          const d = document.createElement("div");
          d.className = "item";
          d.textContent = sound.name;
          d.draggable = true;
          d.ondragstart = (e) => e.dataTransfer.setData("soundId", sound.id);
          libEl.appendChild(d);
        });
      }

      importSoundsBtn.onclick = () => importSoundsFile.click();
      importSoundsFile.onchange = async () => {
        for (const file of importSoundsFile.files) {
          const data = await file.arrayBuffer();
          store("sounds", "readwrite").put({
            id: uuid(),
            name: file.name,
            data,
          });
        }
        importSoundsFile.value = "";
        await load();
      };

      importKitBtn.onclick = () => importKitFile.click();
      importKitFile.onchange = async () => {
        const file = importKitFile.files[0];
        if (!file) return;
        try {
          const parsed = JSON.parse(await file.text());
          kit = parsed.pads;
          store("kit", "readwrite").put({ key: "default", kit });
          render();
        } catch {
          alert("Invalid kit.json");
        }
        importKitFile.value = "";
      };

      dropEl.ondragover = (e) => {
        e.preventDefault();
        dropEl.classList.add("drag");
      };
      dropEl.ondragleave = () => dropEl.classList.remove("drag");
      dropEl.ondrop = async (e) => {
        e.preventDefault();
        dropEl.classList.remove("drag");
        for (const f of e.dataTransfer.files) {
          if (!f.type.startsWith("audio/")) continue;
          const data = await f.arrayBuffer();
          store("sounds", "readwrite").put({ id: uuid(), name: f.name, data });
        }
        await load();
      };

      document.getElementById("clearAll").onclick = async () => {
        if (!confirm("Clear everything?")) return;
        store("sounds", "readwrite").clear();
        store("kit", "readwrite").clear();
        sounds = [];
        kit = Array.from({ length: PAD_COUNT }, () => ({ soundId: null }));
        render();
      };

      document.getElementById("arm").onclick = () => audioCtx.resume();
      document.getElementById("stopAll").onclick = () => audioCtx.close();

      (async () => {
        db = await openDb();
        await load();
      })();

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js");
      }
    </script>
  </body>
</html>
